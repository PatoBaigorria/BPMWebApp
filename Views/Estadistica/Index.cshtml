@model List<SupervisorEstadisticaDTO>

<div class="container-fluid">
    <h2 class="h3 mb-2 mt-3 text-gray-800">Cantidad de Auditorías por Supervisor</h2>

    <div class="card shadow mb-2">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
            <h6 class="m-0 font-weight-bold text-primary">Filtros</h6>
        </div>
        <div class="card-body">
            <form method="get" class="row g-2">
                <div class="col-md-4">
                    <label class="form-label">Desde:</label>
                    <input type="date" name="desde" value="@ViewBag.Desde" class="form-control">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Hasta:</label>
                    <input type="date" name="hasta" value="@ViewBag.Hasta" class="form-control">
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-filter"></i> Filtrar
                    </button>
                </div>
            </form>
        </div>
    </div>

    @if (ViewBag.Error != null)
    {
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i> @ViewBag.Error
        </div>
    }

    <div class="card shadow mb-2">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Resumen de Auditorías por Supervisor</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="dataTable" width="100%" cellspacing="0">
                    <thead class="table-primary">
                        <tr>
                            <th>Supervisor</th>
                            <th class="text-center">Cantidad</th>
                            <th class="text-center">Auditorías Positivas</th>
                            <th class="text-center">Auditorías Negativas</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model != null && Model.Any())
                        {
                            @foreach (var item in Model)
                            {
                                <tr>
                                    <td>@(item.Supervisor != null ? $"{item.Supervisor.Apellido}, {item.Supervisor.Nombre}" : "Supervisor no disponible")</td>
                                    <td class="text-center">@item.TotalAudits</td>
                                    <td class="text-center">@item.PositiveAudits</td>
                                    <td class="text-center">@item.NegativeAudits</td>
                                    <td class="text-center">
                                        @if (item.Supervisor != null)
                                        {
                                            <a href="@Url.Action("Index", "AuditoriasRealizadas", new { supervisor = item.Supervisor.Apellido })" class="btn btn-sm btn-info">
                                                <i class="fas fa-eye"></i> Ver Auditorías
                                            </a>
                                        }
                                        else
                                        {
                                            <span class="text-muted">N/A</span>
                                        }
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="5" class="text-center">No se encontraron auditorías en el período seleccionado.</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    @if (Model != null && Model.Any())
    {
        <div class="row">
            <div class="col-xl-6">
                <div class="card shadow mb-2">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Distribución de Auditorías</h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-pie pt-2" style="height: 180px;">
                            <canvas id="auditoriasChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-6">
                <div class="card shadow mb-2">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Comparación de Supervisores</h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-bar" style="height: 180px;">
                            <canvas id="supervisoresChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-xl-12">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Auditorías No Conformes por Línea</h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-bar" style="height: 300px;">
                            <canvas id="lineasChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        $(document).ready(function () {
            
            // ---------------------------------------------------------
            // 1. Configuración de la Tabla
            // ---------------------------------------------------------
            if ($('#dataTable tbody tr').length > 0 && !$('#dataTable tbody tr td[colspan]').length) {
                var baseConfig = (typeof dataTableConfig !== 'undefined') ? dataTableConfig : {};
                var config = Object.assign({}, baseConfig, { order: [[1, 'desc']] });
                $('#dataTable').DataTable(config);
            }

            // ---------------------------------------------------------
            // 2. Gráficos Originales (Actualizados a sintaxis Chart.js v4)
            // ---------------------------------------------------------
            @if (Model != null && Model.Any())
            {
                var totalPositivas = Model.Sum(m => m.PositiveAudits);
                var totalNegativas = Model.Sum(m => m.NegativeAudits);
                
                var supervisoresList = new List<string>();
                var positivasList = new List<int>();
                var negativasList = new List<int>();
                
                foreach (var item in Model.Take(5))
                {
                    supervisoresList.Add($"{item.Supervisor?.Apellido}, {item.Supervisor?.Nombre}");
                    positivasList.Add(item.PositiveAudits);
                    negativasList.Add(item.NegativeAudits);
                }
                
                var supervisoresJson = System.Text.Json.JsonSerializer.Serialize(supervisoresList);
                var positivasJson = System.Text.Json.JsonSerializer.Serialize(positivasList);
                var negativasJson = System.Text.Json.JsonSerializer.Serialize(negativasList);

                <text>
                // --- Gráfico de Torta ---
                var ctxPie = document.getElementById('auditoriasChart');
                if (ctxPie) {
                    new Chart(ctxPie.getContext('2d'), {
                        type: 'pie',
                        data: {
                            labels: ['Positivas', 'Negativas'],
                            datasets: [{
                                data: [@totalPositivas, @totalNegativas],
                                backgroundColor: ['#1cc88a', '#e74a3b'],
                                hoverBackgroundColor: ['#17a673', '#c93a2d'],
                                hoverBorderColor: "rgba(234, 236, 244, 1)",
                            }],
                        },
                        options: {
                            maintainAspectRatio: false,
                            rotation: 180,
                            plugins: {
                                legend: { display: true, position: 'bottom' }
                            },
                            cutout: '80%', 
                        }
                    });
                }

                // --- Gráfico de Barras (Supervisores) ---
                var ctxBar = document.getElementById('supervisoresChart');
                if (ctxBar) {
                    new Chart(ctxBar.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: @Html.Raw(supervisoresJson),
                            datasets: [
                                { label: "Positivas", backgroundColor: "#1cc88a", data: @Html.Raw(positivasJson) },
                                { label: "Negativas", backgroundColor: "#e74a3b", data: @Html.Raw(negativasJson) }
                            ],
                        },
                        options: {
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: true, position: 'bottom' }
                            },
                            scales: {
                                x: { grid: { display: false } }, // Sintaxis v4 correcta
                                y: { beginAtZero: true }         // Sintaxis v4 correcta
                            }
                        }
                    });
                }
                </text>
            }

            // ---------------------------------------------------------
            // 3. NUEVO Gráfico (Desde API 5222)
            // ---------------------------------------------------------
            
            var inputDesde = $('input[name="desde"]').val();
            var inputHasta = $('input[name="hasta"]').val();

            // NOTA: Si tu web está en HTTPS (candado cerrado), el navegador podría bloquear
            // la petición a HTTP (5222). Si eso pasa, prueba cambiar 'http' por 'https'
            // y el puerto a 7xxx (el puerto seguro de tu API si lo tiene).
            var apiUrl = `http://localhost:5222/api/Estadisticas/no-conforme?desde=${inputDesde}&hasta=${inputHasta}`;
            
            console.log("--> INTENTANDO CONECTAR A: ", apiUrl);

            $.ajax({
                url: apiUrl,
                type: 'GET',
                success: function (data) {
                    console.log("--> DATOS RECIBIDOS:", data);
                    var conteoPorLinea = {};

                    if (data && Array.isArray(data)) {
                        data.forEach(function(item) {
                            if (item.noConforme === true) {
                                var nombreLinea = "Línea " + (item.idLinea || "?");
                                if (conteoPorLinea[nombreLinea]) {
                                    conteoPorLinea[nombreLinea]++;
                                } else {
                                    conteoPorLinea[nombreLinea] = 1;
                                }
                            }
                        });
                    }

                    var labels = Object.keys(conteoPorLinea);
                    var valores = Object.values(conteoPorLinea);

                    var ctxLineas = document.getElementById("lineasChart");
                    if (ctxLineas) {
                        new Chart(ctxLineas, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: "No Conformes",
                                    backgroundColor: "purple",
                                    borderColor: "#e74a3b",
                                    data: valores,
                                }],
                            },
                            options: {
                                maintainAspectRatio: false,
                                layout: { padding: { left: 10, right: 25, top: 25, bottom: 0 } },
                                plugins: {
                                    legend: { display: false },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                return context.parsed.y + " Auditorías";
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    x: { 
                                        grid: { display: false, drawBorder: false },
                                        ticks: { maxRotation: 0 }
                                    },
                                    y: { 
                                        beginAtZero: true,
                                        ticks: { precision: 0 },
                                        grid: { borderDash: [2] }
                                    }
                                }
                            }
                        });
                    }
                },
                error: function (xhr, status, error) {
                    console.error("--> ERROR FINAL:", error);
                    console.log("--> RESPUESTA SERVIDOR:", xhr.responseText);
                    
                    // Alerta visual si falla por Mixed Content o 404
                    if(status === 0 || status === 404) {
                        console.warn("Posible error de puerto o Mixed Content (HTTP vs HTTPS).");
                    }
                }
            });

        });
    </script>
}